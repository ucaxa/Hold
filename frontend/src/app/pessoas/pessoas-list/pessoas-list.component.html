<div class="p-3 relative">
  <div class="mb-6 pb-5 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-700">Cadastro de Pessoas</h2>
  </div>
  <div class="flex flex-col gap-2 mb-3">
    <div class="flex items-center gap-2">
      <input
        type="text"
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearchTermChange($event)"
        placeholder="Buscar por nome..."
        class="w-96 px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
      />
      <button type="button" (click)="onPesquisar()" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
        Pesquisar
      </button>
      <button type="button" (click)="openFormForNew()" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Incluir</button>
    </div>
    <div class="flex items-center gap-2 flex-wrap">
      <button type="button" (click)="openForm(selectedPessoa() ?? undefined)" [disabled]="!canAlterOrExclude()"
              [title]="!searchPerformed() ? 'Faça uma pesquisa primeiro' : (!selectedPessoa() ? 'Selecione um registro na tabela' : 'Alterar')"
              class="px-3 py-1.5 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed text-blue-600 border-blue-200 hover:bg-blue-50">
        Alterar
      </button>
      <button type="button" (click)="onExcluir()" [disabled]="!canAlterOrExclude()"
              [title]="!searchPerformed() ? 'Faça uma pesquisa primeiro' : (!selectedPessoa() ? 'Selecione um registro na tabela' : 'Excluir')"
              class="px-3 py-1.5 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed text-red-600 border-red-200 hover:bg-red-50">
        Excluir
      </button>
      <button type="button" (click)="openPesoIdeal()" [disabled]="!canAlterOrExclude()"
              [title]="!canAlterOrExclude() ? 'Pesquise e encontre registros para habilitar' : (!selectedPessoa() ? 'Selecione um registro na tabela' : 'Calcular peso ideal')"
              class="px-3 py-1.5 text-sm rounded disabled:opacity-50 disabled:cursor-not-allowed bg-orange-500 text-white hover:bg-orange-600">
        Peso Ideal
      </button>
    </div>
    @if (successMessage()) {
      <div class="flex justify-center">
        <span class="px-4 py-2 text-sm bg-green-600 text-white rounded font-medium flex items-center gap-2">
          <span>✓</span>
          {{ successMessage() }}
        </span>
      </div>
    }
  </div>

  @if (loading() && pessoas().length === 0) {
    <div class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="ml-2 text-sm text-gray-600">Carregando...</span>
    </div>
  } @else if (error()) {
    <div class="flex justify-center items-center py-8 gap-2">
      <span class="text-red-600 text-sm">{{ error() }}</span>
      <button type="button" (click)="loadPessoas()" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">Tentar novamente</button>
    </div>
  } @else {
    <div class="bg-white rounded border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">CPF</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data Nasc.</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sexo</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Altura</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">E-mail</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @if (pessoas().length === 0) {
              <tr>
                <td colspan="7" class="px-3 py-6 text-center text-gray-500 text-sm">
                  Pesquisar para listar ou Incluir para cadastrar.
                </td>
              </tr>
            } @else {
              @for (p of pessoas(); track p.id) {
                <tr
                  (click)="selectRow(p)"
                  [class.bg-blue-200]="selectedPessoa()?.id === p.id"
                  [class.border-l-4]="selectedPessoa()?.id === p.id"
                  [class.border-blue-600]="selectedPessoa()?.id === p.id"
                  class="hover:bg-gray-50 cursor-pointer border-l-4 border-transparent"
                >
                  <td class="px-3 py-2 text-gray-900">{{ p.id }}</td>
                  <td class="px-3 py-2 font-medium text-gray-900">{{ p.nome }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ p.cpf || '-' }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ formatDate(p.dataNascimento) }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ sexoLabel(p.sexo) }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ p.altura }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ p.email || '-' }}</td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
      @if (!useSearch() && totalElements() > 0) {
        <div class="flex flex-wrap items-center justify-between px-3 py-2 bg-white border-t border-gray-200 gap-2 text-xs">
          <span class="text-gray-600">{{ (page() * pageSize()) + 1 }}-{{ endItem() }} de {{ totalElements() }}</span>
          <div class="flex items-center gap-1">
            <button type="button" (click)="goToPage(page() - 1)" [disabled]="page() === 0"
                    class="px-2 py-1 rounded border border-gray-300 text-xs disabled:opacity-50 hover:bg-gray-50">Ant.</button>
            @for (n of pageNumbers(); track n) {
              <button type="button" (click)="goToPage(n)"
                      [class.bg-blue-600]="page() === n" [class.text-white]="page() === n" [class.border-blue-600]="page() === n"
                      class="px-2 py-1 rounded border border-gray-300 text-xs hover:bg-gray-50">{{ n + 1 }}</button>
            }
            <button type="button" (click)="goToPage(page() + 1)" [disabled]="page() >= totalPages() - 1"
                    class="px-2 py-1 rounded border border-gray-300 text-xs disabled:opacity-50 hover:bg-gray-50">Próx.</button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Modal Formulário -->
  @if (formOpen()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg w-full max-w-xl shadow-xl p-5">
        <div class="border-2 border-blue-500 rounded-lg bg-blue-50 p-4">
          <h2 class="text-lg font-bold text-gray-800 mb-3">
            {{ editing() ? 'Alterar Pessoa' : 'Nova Pessoa' }}
          </h2>
          <form (ngSubmit)="onFormSubmit()" class="space-y-3">
            <div class="grid grid-cols-4 gap-2">
              <div class="col-span-4">
                <label class="block text-xs font-medium text-gray-600 mb-1">Nome *</label>
                <input
                  type="text"
                  [ngModel]="formData().nome"
                  (ngModelChange)="updateFormField('nome', $event)"
                  name="nome"
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Nome completo"
                />
                @if (formErrors()['nome']) {
                  <p class="mt-0.5 text-xs text-red-600">{{ formErrors()['nome'] }}</p>
                }
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">CPF</label>
                <input
                  type="text"
                  [ngModel]="formData().cpf"
                  (ngModelChange)="onCpfInput($event)"
                  name="cpf"
                  maxlength="14"
                  class="w-full px-2 py-2 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  [class.border-gray-300]="!formErrors()['cpf']"
                  [class.border-red-500]="formErrors()['cpf']"
                  [class.bg-red-50]="formErrors()['cpf']"
                  placeholder="000.000.000-00"
                />
                @if (formErrors()['cpf']) {
                  <p class="mt-0.5 text-xs text-red-600">{{ formErrors()['cpf'] }}</p>
                }
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Data Nasc.</label>
                <input
                  type="date"
                  [ngModel]="formData().dataNascimento"
                  (ngModelChange)="updateFormField('dataNascimento', $event)"
                  name="dataNascimento"
                  class="w-full px-2 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Sexo *</label>
                <select
                  [ngModel]="formData().sexo"
                  (ngModelChange)="updateFormField('sexo', $event)"
                  name="sexo"
                  class="w-full px-2 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="M">Masculino</option>
                  <option value="F">Feminino</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Altura (m) *</label>
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  [ngModel]="formData().altura"
                  (ngModelChange)="updateFormField('altura', $event)"
                  name="altura"
                  class="w-full px-2 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="1.75"
                />
                @if (formErrors()['altura']) {
                  <p class="mt-0.5 text-xs text-red-600">{{ formErrors()['altura'] }}</p>
                }
              </div>
              <div class="col-span-4">
                <label class="block text-xs font-medium text-gray-600 mb-1">E-mail</label>
                <input
                  type="email"
                  [ngModel]="formData().email"
                  (ngModelChange)="onEmailInput($event)"
                  name="email"
                  class="w-full px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  [class.border-gray-300]="!formErrors()['email']"
                  [class.border-red-500]="formErrors()['email']"
                  [class.bg-red-50]="formErrors()['email']"
                  placeholder="email@exemplo.com"
                />
                @if (formErrors()['email']) {
                  <p class="mt-0.5 text-xs text-red-600">{{ formErrors()['email'] }}</p>
                }
              </div>
            </div>
            @if (formErrors()['submit']) {
              <div class="bg-red-50 border border-red-200 rounded p-2 text-red-700 text-xs">
                {{ formErrors()['submit'] }}
              </div>
            }
            <div class="flex justify-end gap-2 pt-3 border-t border-gray-200">
              <button type="button" (click)="closeForm()" class="px-4 py-1.5 text-sm bg-gray-200 text-gray-700 border border-gray-300 rounded hover:bg-gray-300 font-medium">
                Cancelar
              </button>
              <button type="submit" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">
                {{ editing() ? 'Alterar' : 'Incluir' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Popup Peso Ideal -->
  @if (pesoIdealOpen()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" (click)="closePesoIdeal()">
      <div class="bg-white rounded-lg max-w-sm w-full p-6 shadow-xl" (click)="$event.stopPropagation()">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Peso Ideal</h3>
        @if (pesoIdealLoading()) {
          <div class="flex justify-center py-4">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
          </div>
        } @else if (pesoIdealResult()) {
          <p class="text-gray-700"><strong>{{ pesoIdealResult()!.nome }}</strong></p>
          <p class="text-2xl font-semibold text-blue-600 mt-2">Peso ideal: {{ pesoIdealResult()!.pesoIdealKg }} kg</p>
        }
        <div class="mt-4 flex justify-end">
          <button type="button" (click)="closePesoIdeal()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
            Fechar
          </button>
        </div>
      </div>
    </div>
  }
</div>
